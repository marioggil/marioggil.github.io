<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="aframe.min.js"></script>
    <script src="mindar-image-aframe.prod.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
        }

        #audioControls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(50, 50, 50, 0.9));
            padding: 20px;
            border-radius: 25px;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 90vw;
        }

        #audioControls.show {
            display: block !important; /* Forzar visibilidad */
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .audio-button {
            background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 120px;
        }

        .audio-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .audio-button:active {
            transform: translateY(-1px);
        }

        .audio-button.playing {
            background: linear-gradient(145deg, #11998e 0%, #38ef7d 100%);
            animation: pulse 1.5s infinite;
        }

        .audio-button.paused {
            background: linear-gradient(145deg, #ff6b6b 0%, #ffa500 100%);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(56, 239, 125, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(56, 239, 125, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(56, 239, 125, 0);
            }
        }

        .control-button {
            background: linear-gradient(145deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 0 5px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: linear-gradient(145deg, #34495e 0%, #2c3e50 100%);
            transform: scale(1.05);
        }

        .volume-control {
            margin: 15px 0 10px 0;
            text-align: center;
        }

        .volume-slider {
            width: 200px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        #statusMessage {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            z-index: 999;
            font-size: 16px;
            text-align: center;
        }

        .button-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
        }

        .image-title {
            color: #667eea;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }

        .buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        /* Indicador de persistencia */
        .persistence-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #38ef7d;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="statusMessage">Apunta la c√°mara hacia cualquiera de las im√°genes objetivo</div>

    <a-scene 
        mindar-image="imageTargetSrc: targets_3images.mind;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <!-- Im√°genes objetivo -->
            <img id="card1" src="card1.png" />
            <img id="card2" src="card2.png" />
            <img id="card3" src="card3.png" />
            
            <!-- Audios para Imagen 1 -->
            <audio id="img1_audio1" preload="auto" crossorigin="anonymous">
                <source src="Dance_on_Air.mp3" type="audio/mpeg">
            </audio>
            <audio id="img1_audio2" preload="auto" crossorigin="anonymous">
                <source src="Dance_on_Air.mp3" type="audio/mpeg">
            </audio>
            <audio id="img1_audio3" preload="auto" crossorigin="anonymous">
                <source src="Dance_on_Air.mp3" type="audio/mpeg">
            </audio>
            
            <!-- Audios para Imagen 2 -->
            <audio id="img2_audio1" preload="auto" crossorigin="anonymous">
                <source src="Dance_on_Air.mp3" type="audio/mpeg">
            </audio>
            <audio id="img2_audio2" preload="auto" crossorigin="anonymous">
                <source src="Dance_on_Air.mp3" type="audio/mpeg">
            </audio>
            
            <!-- Audios para Imagen 3 -->
            <audio id="img3_audio1" preload="auto" crossorigin="anonymous">
                <source src="Dance_on_Air.mp3" type="audio/mpeg">
            </audio>
            <audio id="img3_audio2" preload="auto" crossorigin="anonymous">
                <source src="Dance_on_Air.mp3" type="audio/mpeg">
            </audio>
            <audio id="img3_audio3" preload="auto" crossorigin="anonymous">
                <source src="Dance_on_Air.mp3" type="audio/mpeg">
            </audio>
            <audio id="img3_audio4" preload="auto" crossorigin="anonymous">
                <source src="Dance_on_Air.mp3" type="audio/mpeg">
            </audio>
            
            <!-- Modelos 3D -->
            <a-asset-item id="model1" src="n.glb"></a-asset-item>
            <a-asset-item id="model2" src="n2.glb"></a-asset-item>
            <a-asset-item id="model3" src="n3.glb"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- Target 1 -->
        <a-entity mindar-image-target="targetIndex: 0" id="imageTarget1">
            <a-plane src="#card1" position="0 0 0" height="0.552" width="1" rotation="0 0 0"></a-plane>
            <a-gltf-model 
                rotation="0 0 0" 
                position="0 0 0.1" 
                scale="0.005 0.005 0.005" 
                src="#model1"
                animation="property: position; to: 0 0.1 0.1; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate">
            </a-gltf-model>
            <a-text 
                value="üéµ IMAGEN 1" 
                position="0 0.4 0.1" 
                align="center"
                color="#ffffff"
                scale="0.8 0.8 0.8">
            </a-text>
        </a-entity>

        <!-- Target 2 -->
        <a-entity mindar-image-target="targetIndex: 1" id="imageTarget2">
            <a-plane src="#card2" position="0 0 0" height="0.552" width="1" rotation="0 0 0"></a-plane>
            <a-gltf-model 
                rotation="0 0 0" 
                position="0 0 0.1" 
                scale="0.003 0.003 0.003" 
                src="#model2"
                animation="property: rotation; to: 0 360 0; dur: 3000; loop: true">
            </a-gltf-model>
            <a-text 
                value="üé∂ IMAGEN 2" 
                position="0 0.4 0.1" 
                align="center"
                color="#38ef7d"
                scale="0.8 0.8 0.8">
            </a-text>
        </a-entity>

        <!-- Target 3 -->
        <a-entity mindar-image-target="targetIndex: 2" id="imageTarget3">
            <a-plane src="#card3" position="0 0 0" height="0.552" width="1" rotation="0 0 0"></a-plane>
            <a-gltf-model 
                rotation="0 0 0" 
                position="0 0 0.1" 
                scale="0.007 0.007 0.007" 
                src="#model3"
                animation="property: scale; to: 0.009 0.009 0.009; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate">
            </a-gltf-model>
            <a-text 
                value="üé∏ IMAGEN 3" 
                position="0 0.4 0.1" 
                align="center"
                color="#ff6b6b"
                scale="0.8 0.8 0.8">
            </a-text>
        </a-entity>
    </a-scene>

    <!-- Controles de Audio -->
    <div id="audioControls">
        <div id="imageTitle" class="image-title"></div>
        <div id="buttonsContainer" class="buttons-container"></div>

        <div class="volume-control">
            <label style="color: white; font-size: 14px;">üîä Volumen:</label><br>
            <input type="range" class="volume-slider" min="0" max="100" value="70" onchange="changeVolume(this.value)">
        </div>

        <div style="margin-top: 15px; text-align: center;">
            <button class="control-button" onclick="pauseAll()">‚è∏Ô∏è Pausar Todo</button>
            <button class="control-button" onclick="stopAll()">‚èπÔ∏è Detener Todo</button>
            <button class="control-button" onclick="hideMenu()" id="hideButton" style="display: none;">‚ùå Ocultar Men√∫</button>
        </div>
    </div>

    <script>
        // Configuraci√≥n de im√°genes y audios
        const imageConfigs = {
            0: {
                title: "üéµ Imagen Musical",
                audios: [
                    { id: 'img1_audio1', label: 'üéµ Melod√≠a 1' },
                    { id: 'img1_audio2', label: 'üé∂ Armon√≠a' },
                    { id: 'img1_audio3', label: 'üéº Sinfon√≠a' }
                ]
            },
            1: {
                title: "üé∏ Imagen Rockera", 
                audios: [
                    { id: 'img2_audio1', label: 'üé∏ Rock Cl√°sico' },
                    { id: 'img2_audio2', label: 'ü•Å Solo Bater√≠a' }
                ]
            },
            2: {
                title: "üé∫ Imagen Orquestal",
                audios: [
                    { id: 'img3_audio1', label: 'üé∫ Trompeta' },
                    { id: 'img3_audio2', label: 'üéª Viol√≠n' },
                    { id: 'img3_audio3', label: 'üéπ Piano' },
                    { id: 'img3_audio4', label: 'üéµ Coro' }
                ]
            }
        };

        let currentAudio = null;
        let currentButton = null;
        let currentImageIndex = null;

        // Variables para control de persistencia
        let visibleImages = new Set();
        let hasEverDetectedImage = false;
        let menuShouldStayVisible = false;
        let persistenceTimer = null;
        let persistenceObserver = null;

        // Sistema de gesti√≥n de audio mejorado
        class MultiImageAudioController {
            constructor() {
                this.allAudios = {};
                this.volume = 0.7;
                this.setupAllAudios();
            }

            setupAllAudios() {
                // Recopilar todos los audios de todas las configuraciones
                Object.values(imageConfigs).forEach(config => {
                    config.audios.forEach(audioConfig => {
                        const audioElement = document.getElementById(audioConfig.id);
                        if (audioElement) {
                            this.allAudios[audioConfig.id] = audioElement;
                            audioElement.loop = false;
                            audioElement.volume = this.volume;
                            
                            audioElement.addEventListener('ended', () => {
                                this.onAudioEnded(audioElement, audioConfig.id);
                            });
                        }
                    });
                });
            }

            onAudioEnded(audio, audioId) {
                const button = document.querySelector(`[data-audio="${audioId}"]`);
                if (button) {
                    button.classList.remove('playing', 'paused');
                }
                if (currentAudio === audio) {
                    currentAudio = null;
                    currentButton = null;
                }
            }

            play(audioId) {
                // Pausar audio actual si es diferente
                if (currentAudio && this.allAudios[audioId] !== currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    if (currentButton) {
                        currentButton.classList.remove('playing', 'paused');
                    }
                }

                const audio = this.allAudios[audioId];
                if (audio) {
                    if (audio.paused) {
                        audio.play().catch(console.error);
                        return 'playing';
                    } else {
                        audio.pause();
                        return 'paused';
                    }
                }
                return 'stopped';
            }

            pauseAll() {
                Object.values(this.allAudios).forEach(audio => {
                    if (audio && !audio.paused) {
                        audio.pause();
                    }
                });
                
                document.querySelectorAll('.audio-button').forEach(btn => {
                    btn.classList.remove('playing');
                    btn.classList.add('paused');
                });
            }

            stopAll() {
                Object.values(this.allAudios).forEach(audio => {
                    if (audio) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                });

                document.querySelectorAll('.audio-button').forEach(btn => {
                    btn.classList.remove('playing', 'paused');
                });
                
                currentAudio = null;
                currentButton = null;
            }

            setVolume(volume) {
                this.volume = volume / 100;
                Object.values(this.allAudios).forEach(audio => {
                    if (audio) {
                        audio.volume = this.volume;
                    }
                });
            }
        }

        // Inicializar controlador
        const audioController = new MultiImageAudioController();

        // Funci√≥n para forzar persistencia del men√∫
        function forceMenuPersistence() {
            const audioControls = document.getElementById('audioControls');
            if (menuShouldStayVisible && hasEverDetectedImage) {
                if (!audioControls.classList.contains('show')) {
                    console.log('üîí Forzando persistencia del men√∫');
                    audioControls.classList.add('show');
                    audioControls.style.display = 'block';
                }
            }
        }

        // Funci√≥n para a√±adir indicador de persistencia
        function addPersistenceIndicator() {
            const audioControls = document.getElementById('audioControls');
            let indicator = audioControls.querySelector('.persistence-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'persistence-indicator';
                indicator.textContent = 'üîí';
                indicator.title = 'Men√∫ persistente - Se mantiene activo';
                audioControls.style.position = 'relative';
                audioControls.appendChild(indicator);
            }
            document.getElementById('hideButton').style.display = 'inline-block';
        }

        // Funci√≥n para quitar indicador de persistencia
        function removePersistenceIndicator() {
            const audioControls = document.getElementById('audioControls');
            const indicator = audioControls.querySelector('.persistence-indicator');
            if (indicator) {
                indicator.remove();
            }
            document.getElementById('hideButton').style.display = 'none';
        }

        // Funci√≥n para actualizar la UI seg√∫n la imagen detectada
        function updateUIForImage(imageIndex) {
            const config = imageConfigs[imageIndex];
            if (!config) return;

            currentImageIndex = imageIndex;
            
            // Actualizar t√≠tulo
            document.getElementById('imageTitle').textContent = config.title;
            
            // Limpiar botones existentes
            const buttonsContainer = document.getElementById('buttonsContainer');
            buttonsContainer.innerHTML = '';
            
            // Crear botones espec√≠ficos para esta imagen
            config.audios.forEach(audioConfig => {
                const button = document.createElement('button');
                button.className = 'audio-button';
                button.textContent = audioConfig.label;
                button.setAttribute('data-audio', audioConfig.id);
                button.onclick = () => playAudio(audioConfig.id, button);
                buttonsContainer.appendChild(button);
            });
        }

        // Funciones globales
        function playAudio(audioId, buttonElement) {
            const state = audioController.play(audioId);
            currentAudio = audioController.allAudios[audioId];
            currentButton = buttonElement;

            // Actualizar UI del bot√≥n
            document.querySelectorAll('.audio-button').forEach(btn => {
                btn.classList.remove('playing', 'paused');
            });

            if (state === 'playing') {
                buttonElement.classList.add('playing');
                showMessage('üéµ Reproduciendo: ' + buttonElement.textContent);
            } else if (state === 'paused') {
                buttonElement.classList.add('paused');
                showMessage('‚è∏Ô∏è Pausado: ' + buttonElement.textContent);
            }
        }

        function pauseAll() {
            audioController.pauseAll();
            showMessage('‚è∏Ô∏è Todos los audios pausados');
        }

        function stopAll() {
            audioController.stopAll();
            showMessage('‚èπÔ∏è Todos los audios detenidos');
        }

        function changeVolume(value) {
            audioController.setVolume(value);
            showMessage('üîä Volumen: ' + value + '%');
        }

        function hideMenu() {
            const audioControls = document.getElementById('audioControls');
            audioControls.classList.remove('show');
            menuShouldStayVisible = false;
            hasEverDetectedImage = false;
            visibleImages.clear();
            removePersistenceIndicator();
            if (persistenceTimer) {
                clearInterval(persistenceTimer);
                persistenceTimer = null;
            }
            showMessage('‚ùå Men√∫ ocultado manualmente');
        }

        function showMessage(text) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = text;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }

        // Event listeners para detecci√≥n de m√∫ltiples im√°genes
        document.addEventListener('DOMContentLoaded', function() {
            const audioControls = document.getElementById('audioControls');

            // Observer para detectar intentos de ocultar el men√∫
            persistenceObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const target = mutation.target;
                        if (target.id === 'audioControls' && menuShouldStayVisible && hasEverDetectedImage) {
                            if (!target.classList.contains('show')) {
                                console.log('üîÑ MindAR intent√≥ ocultar men√∫, restaurando...');
                                setTimeout(() => {
                                    target.classList.add('show');
                                    target.style.display = 'block';
                                }, 50);
                            }
                        }
                    }
                });
            });

            persistenceObserver.observe(audioControls, {
                attributes: true,
                attributeFilter: ['class', 'style']
            });

            // Configurar eventos para cada target de imagen
            Object.keys(imageConfigs).forEach(targetIndex => {
                const imageTarget = document.getElementById(`imageTarget${parseInt(targetIndex) + 1}`);
                
                if (imageTarget) {
                    imageTarget.addEventListener('targetFound', function() {
                        const imageNum = parseInt(targetIndex) + 1;
                        const targetIdx = parseInt(targetIndex);
                        console.log(`üéØ Imagen ${imageNum} encontrada`);
                        
                        // Limpiar timer de persistencia si existe
                        if (persistenceTimer) {
                            clearInterval(persistenceTimer);
                            persistenceTimer = null;
                        }
                        
                        // Marcar esta imagen como visible
                        visibleImages.add(targetIdx);
                        hasEverDetectedImage = true;
                        menuShouldStayVisible = true;
                        
                        // Quitar indicador si hab√≠a porque ahora hay imagen activa
                        removePersistenceIndicator();
                        
                        // Si es una imagen diferente, actualizar UI
                        if (currentImageIndex !== targetIdx) {
                            updateUIForImage(targetIdx);
                            showMessage(`‚úÖ Imagen ${imageNum} detectada - Men√∫s actualizados`);
                        }
                        
                        // Mostrar controles
                        audioControls.classList.add('show');
                        audioControls.style.display = 'block';
                    });

                    imageTarget.addEventListener('targetLost', function() {
                        const imageNum = parseInt(targetIndex) + 1;
                        const targetIdx = parseInt(targetIndex);
                        console.log(`üìç Imagen ${imageNum} perdida`);
                        
                        // Remover esta imagen del set de visibles
                        visibleImages.delete(targetIdx);
                        
                        // Si no hay im√°genes visibles pero ya se hab√≠a detectado una, activar persistencia
                        if (visibleImages.size === 0 && hasEverDetectedImage) {
                            showMessage(`‚ùå Imagen ${imageNum} perdida - üîí Men√∫s permanecen activos`);
                            console.log('üîí Activando persistencia forzada del men√∫');
                            
                            // A√±adir indicador visual de persistencia
                            addPersistenceIndicator();
                            
                            // Forzar persistencia inmediatamente
                            setTimeout(() => {
                                audioControls.classList.add('show');
                                audioControls.style.display = 'block';
                            }, 100);
                            
                            // Timer de verificaci√≥n cada 300ms
                            persistenceTimer = setInterval(() => {
                                forceMenuPersistence();
                            }, 300);
                            
                        } else if (visibleImages.size > 0) {
                            showMessage(`‚ùå Imagen ${imageNum} perdida - Otras im√°genes a√∫n visibles`);
                        }
                    });
                }
            });

            showMessage('üì± Apunta la c√°mara hacia cualquier imagen objetivo');
        });

        console.log(`
üéµ Multi-Image AR Audio Controller - CON PERSISTENCIA FORZADA

üìã Caracter√≠sticas:
‚Ä¢ Reconoce m√∫ltiples im√°genes objetivo (targets_3images.mind)
‚Ä¢ Cada imagen tiene sus propios audios y botones personalizados
‚Ä¢ Sistema de audio independiente por imagen
‚Ä¢ üîí PERSISTENCIA FORZADA: Los men√∫s se mantienen visibles

üîÑ Comportamiento PERSISTENTE:
‚Ä¢ ‚úÖ Al detectar imagen: Se muestran men√∫s espec√≠ficos
‚Ä¢ üîí Al perder imagen: Men√∫s permanecen FIJOS en pantalla
‚Ä¢ üîÑ Al detectar nueva imagen: Se actualizan men√∫s autom√°ticamente  
‚Ä¢ üìç Indicador visual cuando est√° en modo persistente
‚Ä¢ ‚ùå Bot√≥n manual para ocultar si se desea

üéÆ Configuraci√≥n actual:
‚Ä¢ Imagen 1: ${imageConfigs[0].audios.length} audios - ${imageConfigs[0].title}
‚Ä¢ Imagen 2: ${imageConfigs[1].audios.length} audios - ${imageConfigs[1].title}
‚Ä¢ Imagen 3: ${imageConfigs[2].audios.length} audios - ${imageConfigs[2].title}

üõ°Ô∏è Protecciones implementadas:
‚Ä¢ MutationObserver que detecta intentos de ocultaci√≥n
‚Ä¢ Timer de verificaci√≥n cada 300ms
‚Ä¢ Forzado de display: block y clase show
‚Ä¢ CSS con !important para mayor robustez
        `);
    </script>
</body>
</html>